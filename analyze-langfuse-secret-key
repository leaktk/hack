#! /usr/bin/env python3
import json
import os
import sys

import requests


__doc__ = f"""
USAGE
    {os.path.basename(__file__)} <host> <public-key> <secret-key>

DESCRIPTION
    Validates Langfuse credentials by attempting to list traces.

    <host>        The Langfuse host (e.g., https://cloud.langfuse.com or https://us.cloud.langfuse.com)
    <public-key>  The public key (usually starts with pk-lf-...)
    <secret-key>  The secret key (usually starts with sk-lf-...)
"""

def error(message, **kwargs):
    return {"message": message, **kwargs}

def analyze(host, public_key, secret_key):
    # Ensure host doesn't have trailing slash
    host = host.rstrip('/')

    if not host.startswith("http"):
        host = "https://" + host

    results = {
        "valid": False,
        "analysis": {},
    }

    try:
        # Attempt to list traces (requires read access)
        # Using limit=1 to keep payload light
        endpoint = f"{host}/api/public/traces?limit=1"
        resp = requests.get(endpoint, auth=(public_key, secret_key), timeout=10)

        results["analysis"]["status_code"] = resp.status_code

        if resp.status_code == 200:
            results["valid"] = True
            data = resp.json()

            # Extract basic info
            results["analysis"]["trace_count_in_response"] = len(data.get("data", []))

            # Check if we can see project info (inferred from trace access)
            # We can try to grab a project ID from a trace if available,
            # otherwise just confirm access.
            if data.get("data"):
                results["analysis"]["sample_trace_id"] = data["data"][0].get("id")
                results["analysis"]["sample_project_id"] = data["data"][0].get("projectId")

        elif resp.status_code == 401 or resp.status_code == 403:
            results["valid"] = False
            results["error"] = error("Authentication failed or forbidden", code=resp.status_code)

        else:
            results["error"] = error(
                "Unexpected response from Langfuse",
                code=resp.status_code,
                raw=resp.text[:100]
            )

    except requests.exceptions.RequestException as e:
        results["error"] = error(f"Request failed: {e}")

    return results

if __name__ == "__main__":
    if len(sys.argv) != 4:
        print(__doc__)
        sys.exit(1)

    print(json.dumps(analyze(*sys.argv[1:]), indent=2))
