#! /usr/bin/env python3

import sys
import json
import requests


def analyze_openshift_token(base_url, token):
    headers = {"Authorization": f"Bearer {token}"}

    if not base_url.startswith("http"):
        base_url = "https://" + base_url

    if ".apps." in base_url:
        base_url = f"https://api.{base_url.split('.apps.', 1)[1]}:6443"

    api_url = base_url + "/apis/user.openshift.io/v1/users/~"
    analysis = {"api_base_url": base_url}
    valid = False

    try:
        response = requests.get(api_url, headers=headers, timeout=15, verify=False)

        if response.status_code == 200:
            valid = True
            user_info = response.json()
            analysis["username"] = user_info.get("metadata", {}).get("name")
            analysis["uid"] = user_info.get("metadata", {}).get("uid")
            analysis["groups"] = user_info.get("groups")
        elif response.status_code == 401:
            analysis["error"] = response.json()
        elif response.status_code == 403:
            analysis["error"] = (
                "Token valid, but insufficient permissions for this API call"
            )
            # Technically valid, but we might not get much info to assess risk.
            # Consider attempting a different, more basic API call if this occurs.
            valid = True  # Mark as valid as the token itself is not rejected
        else:
            analysis["error"] = f"Unexpected status code: {response.status_code}"
            analysis["response_body"] = response.text[:500]  # First 500 chars
    except requests.exceptions.RequestException as e:
        analysis["error"] = str(e)

    result = {"valid": valid, "analysis": analysis}
    print(json.dumps(result, indent=2))


if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("USAGE:\n\tanalyse-openshift-token <hostname> <token>")
        sys.exit(1)

    hostname = sys.argv[1]
    token_value = sys.argv[2]
    analyze_openshift_token(hostname, token_value)
