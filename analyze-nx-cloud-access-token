#!/usr/bin/env python3
import json
import sys
import requests
from base64 import b64decode

__doc__ = f"""
USAGE:
    {sys.argv[0]} <access-token>

DESCRIPTION:
    Validates an Nx Cloud access token by fetching the associated user profile.
"""


def analyze(access_token):
    """
    Analyzes the given Nx Cloud access token.
    """
    headers = {"Authorization": access_token}
    api_url = "https://cloud.nx.app/nx-cloud/ping"
    results = {
        "valid": False,
        "analysis": {},
    }

    try:
        resp = requests.get(api_url, headers=headers)

        if resp.status_code == 200:
            results["valid"] = True
            results["analysis"]["ping_resp"] = resp.text
            results["analysis"]["access_token"] = {
                "permissions": b64decode(access_token).decode().split("|")[1],
            }
        elif resp.status_code in [401, 403]:
            # Invalid token, which is a definitive result.
            pass
        else:
            results["error"] = {
                "message": "Unexpected status code from Nx Cloud API",
                "status_code": resp.status_code,
            }
    except requests.exceptions.RequestException as e:
        results["error"] = {"message": f"Request failed: {e}"}

    return results


if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(__doc__)
        sys.exit(1)

    # Use a file name that matches the requirements
    # File name: analyze-nx-cloud-access-token
    print(json.dumps(analyze(*sys.argv[1:])))
