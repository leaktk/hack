#!/usr/bin/env python3

import os
import sys
import json
from pathlib import Path
import logging

logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)

try:
    import git
except ModuleNotFoundError:
    logger.error("please install GitPython to use this script")
    sys.exit(1)


# Attempts to decode bytes using a list of common encodings.
def decode_bytes(data: bytes) -> str:

    encodings_to_try = [
        "utf-8",
        "latin-1",
        "iso-8859-1",
        "cp1252",
        "ascii",
    ]

    for encoding in encodings_to_try:
        try:
            return data.decode(encoding)
        except UnicodeDecodeError:
            continue

    return data.decode("utf-8", errors="replace")


# Opens a local git repository, converts its log to a JSONL file.
def get_git_log_as_jsonl(repo_path: str):

    logger.info(f"Opening repository at {repo_path}...")
    try:
        repo = git.Repo(repo_path)
    except git.exc.InvalidGitRepositoryError:
        logger.error(
            f"Error: Path '{repo_path}' does not contain a valid git repository."
        )
        return False

    logger.info("Generating JSONL file...")

    try:

        for commit in repo.iter_commits("--all"):
            commit_id = commit.hexsha
            message = decode_bytes(commit.message.strip().encode())

            # Handling diffs for the first commit vs. subsequent commits
            if commit.parents:
                diffs = commit.diff(commit.parents[0], create_patch=True)
            else:
                diffs = commit.diff(None, create_patch=True)

            for diff in diffs:
                patch_text = decode_bytes(diff.diff)
                # Use a_path or b_path depending on if the file was added/deleted
                file_path = diff.b_path if diff.b_path else diff.a_path

                if file_path:
                    commit_data = {
                        "id": commit_id,
                        "patch": patch_text,
                        "path": file_path,
                        "author": {
                            "name": commit.author.name,
                            "email": commit.author.email,
                            "date": commit.authored_datetime.isoformat(),
                        },
                        "committer": {
                            "name": commit.committer.name,
                            "email": commit.committer.email,
                            "date": commit.committed_datetime.isoformat(),
                        },
                        "message": message,
                    }
                    print(json.dumps(commit_data, ensure_ascii=False))

    except Exception as e:
        logger.error(f"An unexpected error occurred: {e}")
        return False
    return True


if __name__ == "__main__":
    if len(sys.argv) < 2:
        logger.info("Usage: python3 <script_name>.py <local_repo_path>")
        sys.exit(1)

    repo_path = sys.argv[1]

    get_git_log_as_jsonl(repo_path)
